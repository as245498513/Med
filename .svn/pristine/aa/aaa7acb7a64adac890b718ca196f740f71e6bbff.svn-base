<?php
/*素材模块*/
namespace User\Controller;
use Common\Controller\MemberbaseController;

class SourceController extends MemberbaseController {
    protected $members_model,$role_model,$role_user_model;
    public function index(){

    }
    /**
     *素材分类
     *列表页面
     */
     public function class_list(){
         $wx_source_class = D('Common/WxSourceClass');

         $source_type = I('source_type');
         $class_name = trim(I('class_name'));

         $where['user_id'] = sp_get_current_member_id();
         if($source_type!=0){
             $where['source_type'] = $source_type;
         }
         if($class_name){
            $where['class_name'] = array('like','%'.$class_name.'%');
         }

         $count = $wx_source_class->where($where)->count();
         $page = $this->page($count, 15);

         $list = $wx_source_class->field('id,class_name,class_sort,source_type,createtime')->where($where)->order('class_sort asc,createtime asc')->limit($page->firstRow, $page->listRows)->select();

         $this->assign('list',$list);
         $this->assign('source_type',$source_type);
         $this->assign('class_name',$class_name);
         $this->assign("page", $page->show('Admin'));
         $this->display();
     }
    /**
     *素材分类
     *添加页面
     */
    public function class_add(){
        $this->display();
    }
    /**
     *素材分类
     *添加和编辑
     */
    public function class_add_post(){
        $wx_source_class = D('Common/WxSourceClass');
        $user_id = sp_get_current_member_id();
        if(IS_POST){
            if($wx_source_class->create()!=false){
                //参数
                $class_name = trim(I('class_name'));
                $class_sort = I('class_sort');
                $source_type = I('source_type');
                $class_id = I('class_id');

                if(empty($class_name)||empty($class_sort)||empty($source_type)){
                    $this->error("类别不能为空");
                }else{
                    if(!$class_id){
                        //新增
                        //检查是否存在
                        $is_exist = array(
                            'user_id'=>$user_id,
                            'class_name'=>$class_name,
                            'source_type'=>$source_type
                        );
                        $rs = $wx_source_class->field('id')->where($is_exist)->find();
                        if($rs){
                            $this->error("该分类已存在");
                        }else{
                            $add = array(
                                'class_name'=>$class_name,
                                'class_sort'=>$class_sort,
                                'source_type'=>$source_type,
                                'user_id'=>$user_id,
                                'createtime'=>NOW_TIME
                            );
                            $wx_source_class->add($add);
                            $this->success("添加成功!");
                        }
                    }else{
                        //编辑
                       $save = array(
                           'class_name'=>$class_name,
                           'class_sort'=>$class_sort,
                           'source_type'=>$source_type,
                       );
                        $rs = $wx_source_class->where(array('id'=>$class_id))->save($save);
                        if($rs){
                            $this->success("编辑成功!",U('class_list'));
                        }else{
                            $this->error("编辑失败!");
                        }
                    }
                }
            }else{
                $this->error($wx_source_class->getError());
            }
        }
    }

    /**
     *素材分类
     *删除
     */
    public function class_del_post(){
        $ids = I('ids');
        $wx_source_class = D('Common/WxSourceClass');
        $rs = 0;
        foreach($ids as $key=>$value){
            $del_rs = $wx_source_class->where(array('id'=>$value))->delete();
            if($del_rs){
                $rs++;
            }
        }
        if($rs>0){
            $return  = array('code'=>0,'message'=>'删除成功','data'=>$rs);
        }else{
            $return  = array('code'=>-1,'message'=>'删除失败','data'=>$rs);
        }
        $this->ajaxReturn($return);
    }

    /**
     *素材分类
     *编辑
     */
    public function class_edit(){
        //参数
        $id = I('id');
        $wx_source_class = D('Common/WxSourceClass');
        $class_info = $wx_source_class->field('id,class_name,class_sort,source_type')->where(array('id'=>$id))->find();
        if(!$class_info){
            $this->error("编辑出错");
        }
        $this->assign('class_info',$class_info);
        $this->display('class_add');
    }


    /**
     *朋友圈图文素材
     *列表页面
     */
    public function momentsimgtxt_list(){
        $momentsimgtxt_model = D('Common/WxSourceMomentsImgtxt');
        //参数
        $title = I('title');
        $content = I('content');

        $where['cmf_wx_source_moments_imgtxt.user_id'] = sp_get_current_member_id();
        if($title){
            $where['cmf_wx_source_moments_imgtxt.title'] = array('like','%'.$title.'%');
        }
        if($content){
            $where['cmf_wx_source_moments_imgtxt.content'] = array('like','%'.$content.'%');
        }

        $count = $momentsimgtxt_model->where($where)->count();
        $page = $this->page($count, 15);

        $list = $momentsimgtxt_model->field('cmf_wx_source_moments_imgtxt.id,cmf_wx_source_moments_imgtxt.title,cmf_wx_source_moments_imgtxt.content,cmf_wx_source_moments_imgtxt.comments,cmf_wx_source_moments_imgtxt.createtime,cmf_wx_source_moments_imgtxt.source_class_id,cmf_wx_source_class.class_name')->join('cmf_wx_source_class ON cmf_wx_source_class.id = cmf_wx_source_moments_imgtxt.source_class_id')->where($where)->order('cmf_wx_source_moments_imgtxt.createtime asc')->limit($page->firstRow, $page->listRows)->select();

        $this->assign('list',$list);
        $this->assign('title',$title);
        $this->assign('content',$content);
        $this->assign("page", $page->show('Admin'));
        $this->display();

    }

    /**
     *朋友圈图文素材
     *添加页面
     */
    public function momentsimgtxt_add(){
        $wx_source_class = D('Common/WxSourceClass');
        $user_id = sp_get_current_member_id();
        $class_list = $wx_source_class->where(array('source_type'=>1,'user_id'=>$user_id))->select();
        $this->assign("class_list",$class_list);
        $this->display();
    }

    /**
     *朋友圈图文素材
     *添加提交
     */
    public function momentsimgtxt_add_post(){
        $momentsimgtxt_model = D('Common/WxSourceMomentsImgtxt');
        $user_id = sp_get_current_member_id();
        if(IS_POST){
            if($momentsimgtxt_model->create()!=false){
                $title = I('title');
                $content = I('content');
                $comments = I('comments');
                $source_class = I('source_class');
                $photos_urls = I('photos_url');//图片地址
                $photos_alts = I('photos_alt');//图片名字
                $comments_imgtxt_id = I('comments_imgtxt_id');
                if(!$photos_urls){
                   $this->error("图片不能为空");
                }else{
                    //新增
                    if(!$comments_imgtxt_id){
                        $add = array(
                            'title'=>$title,
                            'content'=>$content,
                            'comments'=>$comments,
                            'photo_urls'=>serialize(json_encode($photos_urls)),
                            'photo_alts'=>serialize(json_encode($photos_alts)),
                            'source_class_id'=>$source_class,
                            'user_id'=>$user_id,
                            'createtime'=>NOW_TIME
                        );
                        $rs = $momentsimgtxt_model->add($add);
                        if(!$rs){
                            $this->error("添加失败");
                        }else{
                            $this->success("添加成功",U('momentsimgtxt_list'));
                        }
                    }else{
                        //编辑
                        $save = array(
                            'title'=>$title,
                            'content'=>$content,
                            'comments'=>$comments,
                            'source_class_id'=>$source_class,
                            'photo_urls'=>serialize(json_encode($photos_urls)),
                            'photo_alts'=>serialize(json_encode($photos_alts)),
                        );
                        $rs = $momentsimgtxt_model->where(array('id'=>$comments_imgtxt_id))->save($save);
                        if(!$rs){
                            $this->error("编辑失败");
                        }else{
                            $this->success("编辑成功",U('momentsimgtxt_list'));
                        }
                    }
                }

            }else{
                $this->error($momentsimgtxt_model->getError());
            }
        }
    }

    /**
     *朋友圈图文素材
     *编辑
     */
    public function momentsimgtxt_edit(){
        //参数
        $id = I('id');
        $momentsimgtxt_model = D('Common/WxSourceMomentsImgtxt');
        $wx_source_class = D('Common/WxSourceClass');
        $info = $momentsimgtxt_model->field('id,title,content,comments,photo_urls,photo_alts,source_class_id')->where(array('id'=>$id))->find();
        $info['photo_urls'] = json_decode(unserialize($info['photo_urls']));
        $info['photo_alts'] = json_decode(unserialize($info['photo_alts']));
        if(!$info){
            $this->error("编辑出错");
        }
        $user_id = sp_get_current_member_id();
        $class_list = $wx_source_class->where(array('source_type'=>1,'user_id'=>$user_id))->select();
        $this->assign('info',$info);
        $this->assign('class_list',$class_list);
        $this->display('momentsimgtxt_add');
    }

    /**
     *朋友圈图文素材
     *删除
     */
    public function momentsimgtxt_del_post(){
        $ids = I('ids');
        $momentsimgtxt_model = D('Common/WxSourceMomentsImgtxt');
        $rs = 0;
        foreach($ids as $key=>$value){
            $del_rs = $momentsimgtxt_model->where(array('id'=>$value))->delete();
            if($del_rs){
                $rs++;
            }
        }
        if($rs>0){
            $return  = array('code'=>0,'message'=>'删除成功','data'=>$rs);
        }else{
            $return  = array('code'=>-1,'message'=>'删除失败','data'=>$rs);
        }
        $this->ajaxReturn($return);
    }


    /**
     *图片素材
     *列表页面
     */
    public function image_list(){
        $image_model = D('Common/WxSourceImage');
        $wx_source_class = D('Common/WxSourceClass');
        $user_id = sp_get_current_member_id();
        //参数
        $title = I('title');
        $source_class_id = I('source_class');

        $where['cmf_wx_source_image.user_id'] = sp_get_current_member_id();
        if($title){
            $where['cmf_wx_source_image.title'] = array('like','%'.$title.'%');
        }
        if($source_class_id!=0){
            $where['cmf_wx_source_image.source_class_id'] = $source_class_id;
        }

        $count = $image_model->where($where)->count();
        $page = $this->page($count, 15);

        $list = $image_model->field('cmf_wx_source_image.id,cmf_wx_source_image.title,cmf_wx_source_image.source_class_id,cmf_wx_source_image.createtime,cmf_wx_source_class.class_name')->join('cmf_wx_source_class ON cmf_wx_source_class.id = cmf_wx_source_image.source_class_id')->where($where)->order('cmf_wx_source_image.createtime asc')->limit($page->firstRow, $page->listRows)->select();

        //分类下拉框
        $class_list = $wx_source_class->where(array('source_type'=>3,'user_id'=>$user_id))->select();

        $this->assign('list',$list);
        $this->assign('title',$title);
        $this->assign('source_class_id',$source_class_id);
        $this->assign("class_list",$class_list);
        $this->assign("page", $page->show('Admin'));
        $this->display();

    }

    /**
     *图片素材
     *添加页面
     */
    public function image_add(){
        $wx_source_class = D('Common/WxSourceClass');
        $user_id = sp_get_current_member_id();
        $class_list = $wx_source_class->where(array('source_type'=>3,'user_id'=>$user_id))->select();
        $this->assign("class_list",$class_list);
        $this->display();
    }


    /**
     *图片素材
     *添加提交
     */
    public function image_add_post(){
        $image_model = D('Common/WxSourceImage');
        $user_id = sp_get_current_member_id();
        if(IS_POST){
            if($image_model->create()!=false){
                $title = I('title');
                $source_class = I('source_class');
                $photos_urls = I('photos_url');//图片地址
                $photos_alts = I('photos_alt');//图片名字
                $image_id = I('image_id');
                if(!$photos_urls){
                    $this->error("图片不能为空");
                }else{
                    //新增
                    if(!$image_id){
                        $add = array(
                            'title'=>$title,
                            'source_class_id'=>$source_class,
                            'photo_urls'=>serialize(json_encode($photos_urls)),
                            'photo_alts'=>serialize(json_encode($photos_alts)),
                            'user_id'=>$user_id,
                            'createtime'=>NOW_TIME
                        );
                        $rs = $image_model->add($add);
                        if(!$rs){
                            $this->error("添加失败");
                        }else{
                            $this->success("添加成功",U('image_list'));
                        }
                    }else{
                        //编辑
                        $save = array(
                            'title'=>$title,
                            'source_class_id'=>$source_class,
                            'photo_urls'=>serialize(json_encode($photos_urls)),
                            'photo_alts'=>serialize(json_encode($photos_alts)),
                        );
                        $rs = $image_model->where(array('id'=>$image_id))->save($save);
                        if(!$rs){
                            $this->error("编辑失败");
                        }else{
                            $this->success("编辑成功",U('image_list'));
                        }
                    }
                }

            }else{
                $this->error($image_model->getError());
            }
        }
    }


    /**
     *图片素材
     *编辑
     */
    public function image_edit(){
        //参数
        $id = I('id');
        $image_model = D('Common/WxSourceImage');
        $wx_source_class = D('Common/WxSourceClass');
        $info = $image_model->field('id,title,photo_urls,photo_alts,source_class_id')->where(array('id'=>$id))->find();
        $info['photo_urls'] = json_decode(unserialize($info['photo_urls']));
        $info['photo_alts'] = json_decode(unserialize($info['photo_alts']));
        if(!$info){
            $this->error("编辑出错");
        }
        $user_id = sp_get_current_member_id();
        $class_list = $wx_source_class->where(array('source_type'=>3,'user_id'=>$user_id))->select();
        $this->assign('info',$info);
        $this->assign('class_list',$class_list);
        $this->display('image_add');
    }

    /**
     *图片素材
     *删除
     */
    public function image_del_post(){
        $ids = I('ids');
        $image_model = D('Common/WxSourceImage');
        $rs = 0;
        foreach($ids as $key=>$value){
            $del_rs = $image_model->where(array('id'=>$value))->delete();
            if($del_rs){
                $rs++;
            }
        }
        if($rs>0){
            $return  = array('code'=>0,'message'=>'删除成功','data'=>$rs);
        }else{
            $return  = array('code'=>-1,'message'=>'删除失败','data'=>$rs);
        }
        $this->ajaxReturn($return);
    }

}