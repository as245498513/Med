<?php
namespace Api\Controller;
use Common\Controller\XxtbaseController;


class XxtController extends XxtbaseController{

	public function index(){

	}
	/**
	 * 授权检测
	 * @interface 2.2
	 * @return [type] [description]
	 */
	public function auth_device_check(){
		//授权参数
		$unique_id = I('unique_id');

		if(empty($unique_id)){
			$this->returnMsg(-2);
		}

		$where = array(
			'unique_id'=>$unique_id
		);
		//搜索当前设备授权是否有效
		$recent_dev = M('xxt_device_auth')->where($where)->order('overtime desc')->find();

		if(empty($recent_dev)){
			$this->returnMsg(-10000,'设备未授权');
		}
		else if($recent_dev['overtime'] < NOW_TIME){
			$this->returnMsg(-10001,'设备授权过期');
		}
		else{
			$this->returnMsg(10000,'设备已授权');
		}
	}

	/**
	 * 设备授权
	 * @interface 2.1
	 * @return [type] [description]
	 */
	public function auth_device(){
		//参数
		$unique_id = I('unique_id');
		$dev_name = I('dev_name');
		$imei = I('imei','123456789');
		$auth_code  = I('auth_code');
		$serial_number  = I('serial_number');
		$auth_ip  = I('auth_ip');

        //参数检查
		if(empty($unique_id)||empty($dev_name)||empty($imei)||empty($auth_code)||empty($auth_ip)||empty($serial_number)){
           $this->returnMsg(-2);
		}

		$where = array(
			'auth_code'=>$auth_code,
		);

		//查询授权码是否有效
		$code_info = M('xxt_code')->where($where)->find();

		if(empty($code_info)){
			$this->returnMsg(-20000,'授权码不存在');
		}
		if($code_info['starttime']!=0){
			if(($code_info['starttime']+$code_info['valid_time']*24*60*60)<NOW_TIME){
				$this->returnMsg(-20001,'授权码已过期');
			}else{
				$this->returnMsg(20000,'授权码已使用');
			}
		}

        //检测设备是否已授权
		$recent_dev = M('xxt_device_auth')->where(array('unique_id'=>$unique_id))->order('overtime desc')->find();

		if($recent_dev['overtime'] > NOW_TIME){
			$this->returnMsg(10000,'设备已授权');
		}
		$save = array(
			'starttime'=>NOW_TIME,
			'unique_id'=>$unique_id,
			'serial_number'=>$serial_number
		);
		//开始授权
		$rs = M('xxt_code')->where(array('auth_code'=>$auth_code))->save($save);
		if($rs){
			$add = array(
				'xxt_code_id'=>$code_info['id'],
				'unique_id'=>$unique_id,
				'dev_name'=>$dev_name,
				'overtime'=>NOW_TIME+$code_info['valid_time']*24*60*60,
				'auth_code'=>$code_info['auth_code'],
				'imei'=>$imei,
				'auth_ip'=>$auth_ip,
				'serial_number'=>$serial_number
			);
			$rs = M('xxt_device_auth')->add($add);
			if($rs){
				$this->returnMsg(10001,'授权成功');
			}else{
				$this->returnMsg(-10002,'授权失败');
			}
		}else{
			$this->returnMsg(-10002,'授权失败');
		}
	}

	private function returnMsg($code,$message=null,$data=null){
		//常用
		switch ($code) {
			case -2:
				$message = "参数错误";
				break;
			case -1:
				$message = "失败";
				break;
			case 0:
				$message = "成功";
				break;

			default:
				# code...
				break;
		}
		$return = array(
			'code'=>$code,
			'message'=>$message,
			'data'=>$data,
		);
		$this->ajaxReturn($return);
	}

}