<admintpl file="header" />
</head>
<body>
	<div class="wrap js-check-wrap">
		<ul class="nav nav-tabs">
			<li class="active">
				<if condition="$finish_order neq 1">
					<a href="{:U('order_apply_list')}">出货申请列表</a>
					<else/>
					<a href="{:U('order_deliver_list')}">已出货列表</a>
				</if>
			</li>
		</ul>
		<form class="well form-search" method="post" <if condition="$finish_order neq 1">action="{:U('order_apply_list')}<else/>action="{:U('order_deliver_list')}</if> ">
		    订单编号:
		    <input type="text" name="order_sn" style="width: 120px;" value="{$order_sn}" placeholder="订单编号">&nbsp;
		    顾客:
			<input type="text" name="customer_name" style="width: 120px;" value="{$customer_name}" placeholder="请输入顾客">&nbsp;
		    <if condition="$is_stockman eq 1">
				销售员:
				<input type="text" name="apply_name" style="width: 120px;" value="{$apply_name}" placeholder="销售员姓名">&nbsp;
		    </if>
			申请时间：
			<input type="text" name="start_time" class="js-datetime" value="{$start_time|default=''}" style="width: 125px;" placeholder="起始时间" autocomplete="off">-
			<input type="text" class="js-datetime" name="end_time" value="{$end_time|default=''}" style="width: 125px;" placeholder="结束时间" autocomplete="off"> &nbsp;
			<input type="submit" class="btn btn-primary" value="搜索">
			<if condition="sp_auth_check(get_current_admin_id(),'Admin/SellFlow/order_apply_add')">
				<if condition="$finish_order neq 1">
					<a class="btn btn-success" href="{:U('Admin/SellFlow/order_apply_add')}">申请出货</a>
				</if>
			</if>
			<!--<if condition="sp_member_auth_check(sp_get_current_member_id(),'Admin/SellFlow/order_apply_add')">
				<a class="btn btn-success" href="{:U('Admin/SellFlow/order_apply_add')}">新增</a>
			</if>-->
		</form>
		<table class="table table-hover table-bordered">
			<thead>
				<tr>
					<th width="16"><label><input type="checkbox" class="js-check-all" data-direction="x" data-checklist="js-check-x"></label></th>
					<th>订单编号</th>
					<th>购买数量</th>
					<th>单价</th>
					<th>总价</th>
					<th>顾客</th>
					<th>联系方式</th>
					<th>销售员</th>
					<th>申请时间</th>
					<th>申请状态</th>
					<th width="120">操作</th>
				</tr>
			</thead>
			<tbody>

				<foreach name="list" item="vo">
				<tr>
					<td><input type="checkbox" class="js-check" data-yid="js-check-y" data-xid="js-check-x" name="ids[]" value="{$vo.id}"></td>
					<td>{$vo.order_sn}</td>
					<td>
						{$vo.goods_num}
						<if condition="($vo.order_state eq 2) or ($vo.order_state eq -2) or ($vo.order_state eq -3)">
						    <a  href="javascript:void(0)" onclick="show_detail('{$vo.order_sn}')">[查看详情]</a>
						</if>
					</td>
					<td>{$vo.goods_price}</td>
					<td>{$vo.order_amount}</td>
					<td>{$vo.customer_name}</td>
					<td>
						<switch name="vo.customer_contact_type">
                            <case value="1">微信号:{$vo.customer_contact}</case>
							<case value="2">QQ号:{$vo.customer_contact}</case>
							<case value="3">手机号:{$vo.customer_contact}</case>
						</switch>
					</td>
					<td>{$vo.sales_name}</td>
					<td>{:date('Y-m-d H:i',$vo['create_order_time'])}</td>
					<td title="{$vo.reject_reason}">
						<switch name="vo.order_state">
							<case value="-3">
								换货完成
							</case>
							<case value="-2">退换申请中</case>
							<case value="-1">申请拒绝<br/>原因:{:mb_strimwidth($vo['reject_reason'],0,15,"...","utf-8")}</case>
							<case value="1">申请中</case>
							<case value="2">已出货</case>
						</switch>
						<!--退换成功订单-->
						<br/>
						<notempty name="vo.return_list">
							退换单号:<br/>
							<foreach name="vo.return_list" item="v">
								<a href="javascript:void(0)" onclick="show_detail('{$v.order_sn}')">{$v.order_sn}<a/><br/>
							</foreach>
						</notempty>
					</td>
					<td>
						<if condition="$vo.order_state eq 1">
						  <if condition="sp_auth_check(get_current_admin_id(),'Admin/SellFlow/order_confirm')">
							<a href="{:U('order_confirm')}/id/{$vo.id}">确认出货</a>|
						  </if>
						  <if condition="sp_auth_check(get_current_admin_id(),'Admin/SellFlow/order_apply_del_post')">
							  <a href="javascript:void(0)" onclick="batch_del('{$vo.order_sn}')">删除</a>|
						  </if>
						</if>
						<if condition="sp_auth_check(get_current_admin_id(),'Admin/SellFlow/order_return_add')">
							<if condition="($vo.order_state eq 2) or ($vo.order_state eq -3)">
							  <a href="{:U('order_return_add')}/id/{$vo.id}">申请换货</a>|
							</if>
						</if>
					</td>
				</tr>
				</foreach>
			</tbody>
		</table>
		<div class="pagination">{$page}</div>
	</div>
	<script src="__PUBLIC__/js/common.js"></script>
	<script src="__PUBLIC__/js/layer/layer.js"></script>
    <script>
		function show_detail(order_sn,return_id){
			layer.open({
				type: 2,
				area: ['600px', '400px'],
				title: '订单详情',
				fixed: false, //不固定
				maxmin: true,
				content: '{:U("SellFlow/order_goods_list")}'+'/order_sn/'+order_sn+'/is_abnormal/0'
			});
		}

		function batch_del(order_sn){
			$.ajax({
				data:{order_sn:order_sn},
				type: "post",
				dataType:"json",
				url:"{:U('order_apply_del_post')}",
				success:function(data){

					console.log(data);
					if(data.code==0){
						alert(data.message);
						location.reload();
					}else{
						alert(data.message);
					}
				}
			});
		}

	</script>
</body>
</html>