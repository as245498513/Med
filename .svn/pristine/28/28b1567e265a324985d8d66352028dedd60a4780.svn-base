<admintpl file="header" />
</head>
<body>
	<div class="wrap js-check-wrap">
		<ul class="nav nav-tabs">
			<li class="active"><a href="{:U('momo_regist_list_ok')}">陌陌成品仓库</a></li>
		</ul>
		<form class="well form-search" method="post" action="{:U('momo_regist_list_ok')}">
			文件状态：
			<select id="is_file_upload" name="is_file_upload" style="width: 80px;">
				<option value="-1"<if condition="$is_file_upload eq -1">selected="selected"</if>>全部</option>
				<option value="0"<if condition="$is_file_upload eq 0">selected="selected"</if>>未上传</option>
				<option value="1"<if condition="$is_file_upload eq 1">selected="selected"</if>>已上传</option>
			</select>
			账号:
			<input type="text" name="register_username" style="width: 120px;font-size:9px;" value="{$register_username}" placeholder="账号">&nbsp;
			检查时间：
			<input type="text" name="start_time" class="js-datetime" value="{$start_time|default=''}" style="width: 110px;" placeholder="起始时间" autocomplete="off">-
			<input type="text" class="js-datetime" name="end_time" value="{$end_time|default=''}" style="width: 110px;" placeholder="结束时间" autocomplete="off"> &nbsp;
			<input type="submit" class="btn btn-primary" value="搜索">
			<!--<a class="btn btn-danger" href="javascript:void(0)" onclick="clearall()">清空</a>-->
			<if condition="sp_auth_check(get_current_admin_id(),'Admin/report/momo_regist_toexcel')">
			  <a class="btn btn-danger" href="javascript:void(0)" onclick="toexcel()">导出excel</a>
			</if>
			<if condition="sp_auth_check(get_current_admin_id(),'Admin/report/momo_regist_download')">
			  <a class="btn btn-danger" href="javascript:void(0)" onclick="todownload()">下载</a>
			</if>
		</form>
		<table class="table table-hover table-bordered">
			<thead>
				<tr>
					<th width="16"><label><input type="checkbox" class="js-check-all" data-direction="x" data-checklist="js-check-x"></label></th>
					<th width="50">序号</th>
					<th>账号</th>
					<th>密码</th>
					<th>手机号</th>
					<th>注册时间</th>
					<th>最后一次检查时间</th>
					<th>设备名</th>
					<th>文件状态</th>
					<th>检查次数</th>
				</tr>
			</thead>
			<tbody>

				<foreach name="list" item="vo">
				<tr>
					<td><input type="checkbox" class="js-check" data-yid="js-check-y" data-xid="js-check-x" name="ids[]" value="{$vo.id}"></td>
					<td>{$vo.id}</td>
					<td>{$vo.register_username}</td>
					<td>{$vo.register_password}</td>
					<td>{$vo.register_mobile}</td>
					<td>{:date("Y-m-d H:i",$vo['createtime'])}</td>
					<td>
						<if condition="$vo.last_check_time neq 0">
							{:date("Y-m-d H:i",$vo['last_check_time'])}
							<else/>
							未检测
						</if>
					</td>
					<td>{$vo.dev_name}</td>
					<td>
						<switch name="vo.is_file_upload" >
							<case value="0">未上传</case>
							<case value="1">已上传</case>
						</switch>
					</td>
					<td>
						{$vo.check_up_num}
						<a  href="javascript:void(0)" onclick="show_detail('{$vo.register_username}')">[查看详情]</a>
					</td>
					<td style="display: none">{$vo.file_upload_time}</td>
					<td style="display: none">{$vo.is_file_upload}</td>
				</tr>
				</foreach>
			</tbody>
		</table>
		<div class="pagination">{$page}</div>
	</div>
	<script src="__PUBLIC__/js/common.js"></script>
	<script src="__PUBLIC__/js/layer/layer.js"></script>
	<script src="__PUBLIC__/js/clipboard.min.js"></script>
    <script>
		function toexcel(){
			//勾选导出
			var ids=[];
			$("input[name^='ids']:checked").each(function(i){
				ids[i]=$(this).val();
			});
			var in_str='';
			for(var i=0;i<ids.length;i++){
				if(i!=(ids.length-1)){
					in_str += ids[i]+',';
				}else{
					in_str += ids[i];
				}
			}

			var url = 'momo_regist_toexcel';

				start_time = $("input[name=start_time]").val();
				end_time  = $("input[name=end_time]").val();
				register_username = $("input[name=register_username]").val();
			    is_file_upload = $('#is_file_upload option:selected') .val();

				if(start_time){
					url += '/start_time/'+start_time;
				}
				if(end_time){
					url += '/end_time/'+end_time;
				}
				if(register_username){
					url += '/register_username/'+register_username;
				}
				if(is_file_upload){
					url += '/is_file_upload/'+is_file_upload;
				}

			   if(in_str){
				 url += '/ids/'+in_str;
			   }
			  url+='/timetype/last_check_time';
			window.location.href="{:U('"+url+"')}";
		}

		function change_sell_status(id,status){
			$.ajax({
				data:{id:id,status:status},
				type: "post",
				dataType:"json",
				url:"{:U('momo_regist_edit')}",
				success:function(data){
					if(data.code==-1){
						alert(data.message);
					}else{
						alert(data.message);
						location.reload();
					}
				}
			});
		}

		//下载文件
		function todownload(){
			var ids=[];
			var is_all_upload=0;
			var html = "<span>请将以下链接复制到迅雷下载</span><button class='btn btn-danger' id='btn_copy' data-clipboard-action='copy' data-clipboard-target='#download_urls'>一键复制</button><br/><ol id='download_urls'>";
			var http_head = "http://10.10.10.10";
			$("input[name^='ids']:checked").each(function(i){
				ids[i]=$(this).val();
				var mobile=$(this).parent().parent().children("td").eq(4).text();
				var password=$(this).parent().parent().children("td").eq(3).text();
				var username=$(this).parent().parent().children("td").eq(2).text();
				var dev_name=$(this).parent().parent().children("td").eq(7).text();
				var upload_time=$(this).parent().parent().children("td").eq(10).text();
				var download_url = "/"+dev_name+"/"+upload_time+"/"+mobile+"-"+password+"-"+username+".tar.gz";
				html += "<li>"+http_head+download_url+"</li>";

				//判断勾选的是否有未上传的文件
				var is_file_upload=$(this).parent().parent().children("td").eq(11).text();
				if(is_file_upload==0){
					is_all_upload++;
				}
			});
			html+="</ol>"
			if(ids.length<1){
				layer.alert("请先勾选下载");
			}else{
				if(is_all_upload!=0){
					layer.alert("你选中的项中有未上传的文件!");
					return;
				}
				layer.open({
					type: 1,
					skin: 'layui-layer-rim', //加上边框
					area: ['420px', '240px'], //宽高
					content: html
				});
			}
		}

		function show_detail(username){
			layer.open({
				type: 2,
				area: ['770px', '530px'],
				title: '选择素材页',
				fixed: false, //不固定
				maxmin: true,
				content: '{:U("report/momo_check_detail_list")}'+'/username/'+username
			});
		}
		$(function(){
			var clipboard = new Clipboard('#btn_copy');
			clipboard.on('success', function(e) {
				layer.alert("复制成功,请到迅雷粘贴下载！");
			});
			clipboard.on('error', function(e) {
				layer.alert("复制失败！请手动复制");
			});
		})


	</script>
</body>
</html>