<?php
// +----------------------------------------------------------------------
// | ThinkCMF [ WE CAN DO IT MORE SIMPLE ]
// +----------------------------------------------------------------------
// | Copyright (c) 2013-2014 http://www.thinkcmf.com All rights reserved.
// +----------------------------------------------------------------------
// | Author: Tuolaji <479923197@qq.com>
// +----------------------------------------------------------------------
/**
 */
namespace Admin\Controller;
use Common\Controller\AdminbaseController;
class XxtController extends AdminbaseController {
    protected $xxt_code_model;
    public function _initialize()
    {
        parent::_initialize();
        $this->xxt_code_model = D('Common/XxtCode');
    }

    public function code_list(){
        $code_model = M(xxt_code);
        $auth_code = I('auth_code');
        $createtime_start = I('createtime_start');
        $createtime_end = I('createtime_end');

        if($auth_code){
            $where['auth_code'] =  array('like','%'.$auth_code.'%');
        }
        if($createtime_start||$createtime_end){
            $where['createtime'] = array('between',array($createtime_start,$createtime_end));
        }

        $list = $code_model->where($where)->order('starttime asc,createtime desc')->select();
        foreach($list as $key=>$value){


        }

        /*$xxtmomo_reg_m = M('xxtmomo_reg');
        $where = array();
        $count = $xxtmomo_reg_m->where($where)->count();
        $page = $this->page($count, 20);
        $list = $xxtmomo_reg_m
            ->where($where)
            ->order("createtime DESC")
            ->limit($page->firstRow, $page->listRows)
            ->select();

        $this->assign("page", $page->show('Admin'));
        $this->assign("list", $list);*/
        $this->assign("list",$list);
        $this->assign("auth_code",$auth_code);
        $this->display();
    }
    /**
     * 添加授权码页面
     */
    public function code_add(){
        $this->display();
    }

    /**
     * 添加授权码
     */
    public function code_add_post(){
        if(IS_POST){
            if($this->xxt_code_model->create()!==false){
                $code_number = I('code_number');
                $valid_time = I('valid_time');
                $type = I('type',0);

                if(empty($code_number)||empty($valid_time)||$type==''){
                    $this->error("参数错误");
                }
                if($code_number>10000){
                    $this->error("数量太大");
                }

                //生成授权码
                $code_arr = $this->create_code($code_number,$valid_time,$type);
                $rs = $this->xxt_code_model->addAll($code_arr);
                //echo $this->xxt_code_model->getLastSql();
                if($rs){
                    $this->success('添加成功',U('xxt/code_list'));
                }else{
                    $this->error($this->xxt_code_model->getError());
                }
            }else{
                $this->error($this->xxt_code_model->getError());
            }

        }
    }

    /**
     * 批量生成授权码
     */
    public function create_code($number=1,$valid_time=30,$type=0){
        $server_ip = gethostbyname($_SERVER['SERVER_NAME']);
        $result = array();
            for($i=0;$i<$number;$i++){
                $rand = rand(0,99999999);
                $nowtime = NOW_TIME;
                $code = md5(md5($server_ip.$rand.$nowtime).NOW_TIME.$rand);
                $result[$i]['auth_code'] = $code;
                $result[$i]['createtime'] = NOW_TIME;
                $result[$i]['valid_time'] = $valid_time;
                $result[$i]['type'] = $type;
            }
        return $result;
    }

}